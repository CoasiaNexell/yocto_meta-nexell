From 13ce975c8108f17a787d60a39c137b7fd3e28a8e Mon Sep 17 00:00:00 2001
From: choonghyun-Jeon <suker@nexell.co.kr>
Date: Tue, 12 Jul 2016 11:59:03 +0900
Subject: [PATCH] Yocto dts & nx_drm file changed for mali working

---
 arch/arm/boot/dts/s5p4418.dtsi      | 31 +++++++++++++++++++++++++++++++
 drivers/gpu/drm/nexell/nx_drm_drv.c |  2 +-
 drivers/gpu/drm/nexell/nx_drm_gem.c | 12 ++++++++++++
 drivers/gpu/drm/nexell/nx_drm_gem.h |  4 ++++
 4 files changed, 48 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/s5p4418.dtsi b/arch/arm/boot/dts/s5p4418.dtsi
index 57cdaf7..0445d89 100644
--- a/arch/arm/boot/dts/s5p4418.dtsi
+++ b/arch/arm/boot/dts/s5p4418.dtsi
@@ -459,6 +459,37 @@
 			status = "disabled";
 		};
 
+		/* gpu@c0070000 { */
+		/* 	compatible = "arm,mali-400", "arm,mali-utgard"; */
+		/* 	reg = <PHYS_BASE_VR 0x10000>; */
+		/* 	interrupts = <IRQ_VR>, <IRQ_VR>, <IRQ_VR>, */
+		/* 		<IRQ_VR>, <IRQ_VR>, <IRQ_VR>; */
+		/* 	interrupt-names = "IRQGP", "IRQGPMMU", "IRQPP0", */
+		/* 		"IRQPPMMU0", "IRQPP1", "IRQPPMMU1"; */
+		/* 	pmu_domain_config = <0x1 0x4 0x8 0x10 0x20 0x0 0x0 0x0 */
+		/* 				0x0 0x2 0x0 0x0>; */
+		/* 	pmu_switch_delay = <0xff>; */
+		/* 	clocks = <&vr>; */
+		/* 	clock-names = "clk_mali"; */
+		/* 	resets = <&nexell_reset RESET_ID_VR>; */
+		/* 	reset-names = "vr-reset"; */
+		/* }; */
+		gpu@c0070000 {
+			compatible = "arm,mali-400", "arm,mali-utgard";
+			reg = <PHYS_BASE_VR 0x10000>;
+			interrupts = <IRQ_VR>, <IRQ_VR>, <IRQ_VR>,
+				   <IRQ_VR>, <IRQ_VR>, <IRQ_VR>, <IRQ_VR>;
+			interrupt-names = "IRQGP", "IRQGPMMU", "IRQPP0",
+				"IRQPPMMU0", "IRQPP1", "IRQPPMMU1",
+				"IRQPMU";
+			pmu_domain_config = <0x1 0x2 0x4 0x0 0x0 0x0 0x0 0x0 0x0 0x1 0x0 0x0>;
+			pmu_switch_delay = <0xff>;
+			clocks = <&vr>;
+			clock-names = "clk_mali";
+			resets = <&nexell_reset RESET_ID_VR>;
+			reset-names = "vr-reset";
+		};
+
 		nexell_usbphy: nexell-usbphy@c0012000 {
 			compatible = "nexell,nexell-usb2-phy";
 			reg = <PHYS_BASE_TIEOFF 0x100>;
diff --git a/drivers/gpu/drm/nexell/nx_drm_drv.c b/drivers/gpu/drm/nexell/nx_drm_drv.c
index 006e592..348a2bc 100644
--- a/drivers/gpu/drm/nexell/nx_drm_drv.c
+++ b/drivers/gpu/drm/nexell/nx_drm_drv.c
@@ -234,7 +234,7 @@ static struct drm_driver nx_drm_driver = {
 	.gem_prime_vunmap = drm_gem_cma_prime_vunmap,
 	.gem_prime_mmap = drm_gem_cma_prime_mmap,
 
-	.dumb_create = drm_gem_cma_dumb_create,
+	.dumb_create = nx_drm_gem_dumb_create,
 	.dumb_map_offset = drm_gem_cma_dumb_map_offset,
 	.dumb_destroy = drm_gem_dumb_destroy,
 
diff --git a/drivers/gpu/drm/nexell/nx_drm_gem.c b/drivers/gpu/drm/nexell/nx_drm_gem.c
index 5b5f939..40df374 100644
--- a/drivers/gpu/drm/nexell/nx_drm_gem.c
+++ b/drivers/gpu/drm/nexell/nx_drm_gem.c
@@ -17,6 +17,7 @@
  */
 #include <drm/drmP.h>
 #include <drm/drm_vma_manager.h>
+#include <drm/drm_gem_cma_helper.h>
 
 #include <linux/shmem_fs.h>
 #include <drm/nexell_drm.h>
@@ -48,6 +49,17 @@ out:
 	return NULL;
 }
 
+int nx_drm_gem_dumb_create(struct drm_file *file_priv,
+		        struct drm_device *drm,
+		        struct drm_mode_create_dumb *args)
+{
+        args->pitch = DIV_ROUND_UP(args->width * args->bpp, 8);
+        /* The pitch should be aligned by 8 */
+        args->pitch = ALIGN(args->pitch, 8);
+
+	return drm_gem_cma_dumb_create_internal(file_priv, drm, args);
+}
+
 int nx_drm_gem_get_ioctl(struct drm_device *dev, void *data,
 			struct drm_file *file_priv)
 {
diff --git a/drivers/gpu/drm/nexell/nx_drm_gem.h b/drivers/gpu/drm/nexell/nx_drm_gem.h
index c9e2b8b..e35b897 100644
--- a/drivers/gpu/drm/nexell/nx_drm_gem.h
+++ b/drivers/gpu/drm/nexell/nx_drm_gem.h
@@ -30,6 +30,10 @@
 int nx_drm_gem_create_ioctl(struct drm_device *drm, void *data,
 			struct drm_file *file_priv);
 
+int nx_drm_gem_dumb_create(struct drm_file *file_priv,
+		        struct drm_device *drm,
+		        struct drm_mode_create_dumb *args);
+
 /* get buffer information to memory region allocated by gem. */
 int nx_drm_gem_get_ioctl(struct drm_device *drm, void *data,
 			struct drm_file *file_priv);
-- 
2.7.4

