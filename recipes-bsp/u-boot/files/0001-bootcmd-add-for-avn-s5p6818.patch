From bb3509bb40035299b3f84334cd4661b4980beb28 Mon Sep 17 00:00:00 2001
From: choonghyun-Jeon <suker@nexell.co.kr>
Date: Fri, 12 Aug 2016 10:42:38 +0900
Subject: [PATCH] bootcmd add for avn s5p6818

Change-Id: I40e516a05265be4d91dc4b68408f64608c674f11
---
 include/configs/s5p6818_arm64_avn_ref.h | 165 +++++++++++++++++++++++---------
 1 file changed, 118 insertions(+), 47 deletions(-)

diff --git a/include/configs/s5p6818_arm64_avn_ref.h b/include/configs/s5p6818_arm64_avn_ref.h
index 4fe1a01..005b4e2 100644
--- a/include/configs/s5p6818_arm64_avn_ref.h
+++ b/include/configs/s5p6818_arm64_avn_ref.h
@@ -28,7 +28,7 @@
 /* malloc() pool */
 #define	CONFIG_MEM_MALLOC_START			0x44000000
 /* more than 2M for ubifs: MAX 16M */
-#define CONFIG_MEM_MALLOC_LENGTH		32*1024*1024
+#define CONFIG_MEM_MALLOC_LENGTH		(32*1024*1024)
 
 /* when CONFIG_LCD */
 #define CONFIG_FB_ADDR				0x46000000
@@ -139,13 +139,11 @@
 #define	CONFIG_CMDLINE_TAG			/* use bootargs commandline */
 #undef	CONFIG_BOOTM_NETBSD
 #undef	CONFIG_BOOTM_RTEMS
+#define CONFIG_INITRD_TAG
 
 /*-----------------------------------------------------------------------
  * serial console configuration
  */
-/*-----------------------------------------------------------------------
- * serial console configuration
- */
 #define CONFIG_S5P_SERIAL
 #define CONFIG_S5P_SERIAL_INDEX                 3
 #define CONFIG_S5P_SERIAL_CLOCK                 50000000
@@ -164,47 +162,6 @@
 #define	CONFIG_SYS_NO_FLASH
 
 /*-----------------------------------------------------------------------
- * PLL
- */
-
-#define CONFIG_SYS_PLLFIN			24000000UL
-
-/*-----------------------------------------------------------------------
- * Timer
- */
-
-#define CONFIG_TIMER_SYS_TICK_CH		0
-
-/*-----------------------------------------------------------------------
- * GPT
- */
-#define CONFIG_CMD_GPT
-#define CONFIG_EFI_PARTITION
-#define CONFIG_PARTITION_UUIDS
-#define CONFIG_RANDOM_UUID
-
-/*-----------------------------------------------------------------------
- * Fastboot and USB OTG
- */
-
-#define CONFIG_USB_FUNCTION_FASTBOOT
-#define CONFIG_CMD_FASTBOOT
-#define CONFIG_FASTBOOT_FLASH
-#define CONFIG_FASTBOOT_FLASH_MMC_DEV   0
-#define CONFIG_FASTBOOT_BUF_SIZE        (CONFIG_SYS_SDRAM_SIZE - SZ_1M)
-#define CONFIG_FASTBOOT_BUF_ADDR        CONFIG_SYS_SDRAM_BASE
-#define CONFIG_USB_GADGET
-#define CONFIG_USB_GADGET_DUALSPEED
-#define CONFIG_USB_GADGET_VBUS_DRAW     0
-#define CONFIG_USB_GADGET_DWC2_OTG
-#define CONFIG_USB_GADGET_NX_UDC_OTG_PHY
-#define CONFIG_USB_GADGET_DOWNLOAD
-#define CONFIG_SYS_CACHELINE_SIZE       64
-#define CONFIG_G_DNL_VENDOR_NUM         0x18d1  /* google */
-#define CONFIG_G_DNL_PRODUCT_NUM        0x0002  /* nexus one */
-#define CONFIG_G_DNL_MANUFACTURER       "Nexell Corporation"
-
-/*-----------------------------------------------------------------------
  * SD/MMC
  */
 
@@ -248,12 +205,53 @@
 	/* default: CONFIG_ENV_IS_NOWHERE */
 	#define CONFIG_ENV_IS_NOWHERE
 	#define	CONFIG_ENV_OFFSET		1024
-	#define CONFIG_ENV_SIZE			4*1024		/* env size */
+	#define CONFIG_ENV_SIZE			(4*1024)	/* env size */
 	/* imls - list all images found in flash, default enable so disable */
 	#undef	CONFIG_CMD_IMLS
 #endif
 
 /*-----------------------------------------------------------------------
+ * PLL
+ */
+
+#define CONFIG_SYS_PLLFIN			24000000UL
+
+/*-----------------------------------------------------------------------
+ * Timer
+ */
+
+#define CONFIG_TIMER_SYS_TICK_CH		0
+
+/*-----------------------------------------------------------------------
+ * GPT
+ */
+#define CONFIG_CMD_GPT
+#define CONFIG_EFI_PARTITION
+#define CONFIG_PARTITION_UUIDS
+#define CONFIG_RANDOM_UUID
+
+/*-----------------------------------------------------------------------
+ * Fastboot and USB OTG
+ */
+
+#define CONFIG_USB_FUNCTION_FASTBOOT
+#define CONFIG_CMD_FASTBOOT
+#define CONFIG_FASTBOOT_FLASH
+#define CONFIG_FASTBOOT_FLASH_MMC_DEV   0
+#define CONFIG_FASTBOOT_BUF_SIZE        (CONFIG_SYS_SDRAM_SIZE - SZ_1M)
+#define CONFIG_FASTBOOT_BUF_ADDR        CONFIG_SYS_SDRAM_BASE
+#define CONFIG_USB_GADGET
+#define CONFIG_USB_GADGET_DUALSPEED
+#define CONFIG_USB_GADGET_VBUS_DRAW     0
+#define CONFIG_USB_GADGET_DWC2_OTG
+#define CONFIG_USB_GADGET_NX_UDC_OTG_PHY
+#define CONFIG_USB_GADGET_DOWNLOAD
+#define CONFIG_SYS_CACHELINE_SIZE       64
+#define CONFIG_G_DNL_VENDOR_NUM         0x18d1  /* google */
+#define CONFIG_G_DNL_PRODUCT_NUM        0x0002  /* nexus one */
+#define CONFIG_G_DNL_MANUFACTURER       "Nexell Corporation"
+
+/*-----------------------------------------------------------------------
  * Nexell USB Downloader
  */
 #define CONFIG_NX_USBDOWN
@@ -279,11 +277,84 @@
 #define CONFIG_FIT_BEST_MATCH
 #define CONFIG_OF_LIBFDT
 
+#define CONFIG_ROOT_DEV         0
+#define CONFIG_BOOT_PART        1
+#define CONFIG_MODULE_PART      2
+#define CONFIG_ROOT_PART        3
+
+#define CONFIG_DEFAULT_CONSOLE          "console=ttySAC3,115200n8\0"
+
 /*-----------------------------------------------------------------------
  * ENV
  */
 #define CONFIG_EXTRA_ENV_SETTINGS	\
-			"fdt_high=0xffffffffffffffff"
+         "fdt_high=0xffffffffffffffff\0"                                 \
+         "initrd_high=0xffffffffffffffff\0"                              \
+         "kerneladdr=0x48000000\0"                                       \
+         "kernel_file=uImage\0"                                          \
+         "ramdiskaddr=0x49000000\0"                                      \
+         "ramdisk_file=ramdisk.gz\0"                                     \
+         "fdtaddr=0x4a000000\0"                                          \
+         "load_fdt="                                                     \
+                 "loop=$board_rev; "                                     \
+                 "number=$board_rev: "                                   \
+                 "success=0; "                                           \
+                 "until test $loop -eq 0 || test $success -ne 0; do "    \
+                         "if test $loop -lt 10; then "                   \
+                                 "number=0$loop; "                       \
+                         "else number=$loop; "                           \
+                         "fi; "                                          \
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev${number}.dtb && setexpr success 1; " \
+                         "setexpr loop $loop - 1; "                      \
+                         "done; "                                        \
+                 "if test $success -eq 0; then "                         \
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev00.dtb || "	\
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev01.dtb; "	\
+                 "fi; \0"                                                \
+         "console=" CONFIG_DEFAULT_CONSOLE                               \
+         "consoleon=set console=" CONFIG_DEFAULT_CONSOLE                 \
+                 "; saveenv; reset\0"                                    \
+         "consoleoff=set console=ram; saveenv; reset\0"                  \
+         "rootdev=" __stringify(CONFIG_ROOT_DEV) "\0"                    \
+         "rootpart=" __stringify(CONFIG_ROOT_PART) "\0"                  \
+         "bootpart=" __stringify(CONFIG_BOOT_PART) "\0"                  \
+         "root_rw=rw\0"                                                  \
+         "opts=loglevel=4\0"                                             \
+         "rootfs_type=ext4\0"                                            \
+         "lcd1_0=s6e8fa0\0"                                              \
+         "lcd2_0=gst7d0038\0"                                            \
+         "lcd_panel=s6e8fa0\0"                                           \
+         "sdrecovery=sd_recovery mmc 1:3 48000000 partmap_emmc.txt\0"    \
+         "factory_set_ethaddr=run factory_load; gen_eth_addr ;"          \
+                 "factory_info write ethaddr $ethaddr;"                  \
+                 "run factory_save\0"                                    \
+         "boot_cmd_initrd="                                              \
+                 "run load_fdt;"                                         \
+                 "ext4load mmc ${rootdev}:${bootpart} $kerneladdr $kernel_file;" \
+                 "ext4load mmc ${rootdev}:${bootpart} $ramdiskaddr $ramdisk_file;" \
+                 "bootm $kerneladdr - $fdtaddr\0"                \
+         "ramfsboot=setenv bootargs ${console} "                         \
+                 "root=/dev/ram0 ${root_rw} initrd=${ramdiskaddr},16M ramdisk=16384 "    \
+                 "${opts} ${recoverymode} bd_addr=${bd_addr} "           \
+                 "drm_panel=$lcd_panel;"                                 \
+                 "run boot_cmd_initrd\0"                                 \
+          "mmcboot=setenv bootargs ${console} "                           \
+                 "root=/dev/mmcblk${rootdev}p${rootpart} ${root_rw} "    \
+                 "${opts} bd_addr=${bd_addr} "                           \
+                 "drm_panel=$lcd_panel;"                                 \
+                 "run boot_cmd_initrd\0"                                 \
+         "recoveryboot=run sdrecovery; setenv recoverymode recovery;"    \
+                 "run ramfsboot\0"                                       \
+         "hwtestboot=run sdrecovery; setenv rootdev 1;"                  \
+                 "setenv opts rootfstype=ext4 rootwait loglevel=7;"      \
+                 "ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref.dtb; "      \
+                 "ext4load mmc ${rootdev}:${bootpart} $kerneladdr $kernel_file;" \
+                 "setenv bootargs ${console} "                           \
+                 "root=/dev/mmcblk${rootdev}p${rootpart} ${root_rw} "    \
+                 "${opts} ${recoverymode} bd_addr=${bd_addr};"           \
+                 "bootm $kerneladdr - $fdtaddr\0"                \
+         "bootcmd=run mmcboot\0"
+
 
 #define CONFIG_BOOTCOMMAND	\
 	"ext4load mmc 0:1 0x48000000 uImage; " \
-- 
2.7.4

