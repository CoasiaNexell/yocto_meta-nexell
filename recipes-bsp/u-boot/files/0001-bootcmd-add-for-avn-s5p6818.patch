From 29fdbd3f81e4acf200ade6675af334a4c4143ad6 Mon Sep 17 00:00:00 2001
From: choonghyun-Jeon <suker@nexell.co.kr>
Date: Thu, 8 Sep 2016 15:20:46 +0900
Subject: [PATCH] bootcmd add for avn s5p6818

Change-Id: I25a4bc0c00be5827e6ccd7e752f9cc43f52f89c3
---
 include/configs/s5p6818_arm64_avn_ref.h | 114 ++++++++++++++++++++++++++++----
 1 file changed, 102 insertions(+), 12 deletions(-)

diff --git a/include/configs/s5p6818_arm64_avn_ref.h b/include/configs/s5p6818_arm64_avn_ref.h
index 4fe1a01..965181a 100644
--- a/include/configs/s5p6818_arm64_avn_ref.h
+++ b/include/configs/s5p6818_arm64_avn_ref.h
@@ -27,8 +27,9 @@
 
 /* malloc() pool */
 #define	CONFIG_MEM_MALLOC_START			0x44000000
+
 /* more than 2M for ubifs: MAX 16M */
-#define CONFIG_MEM_MALLOC_LENGTH		32*1024*1024
+#define CONFIG_MEM_MALLOC_LENGTH               32*1024*1024
 
 /* when CONFIG_LCD */
 #define CONFIG_FB_ADDR				0x46000000
@@ -139,6 +140,7 @@
 #define	CONFIG_CMDLINE_TAG			/* use bootargs commandline */
 #undef	CONFIG_BOOTM_NETBSD
 #undef	CONFIG_BOOTM_RTEMS
+#define CONFIG_INITRD_TAG
 
 /*-----------------------------------------------------------------------
  * serial console configuration
@@ -220,12 +222,12 @@
 #define CONFIG_2NDBOOT_SIZE		(64*1024)
 #define CONFIG_FIP_OFFSET		(CONFIG_2NDBOOT_OFFSET +\
 					 CONFIG_2NDBOOT_SIZE)
-#define CONFIG_FIP_SIZE			(3*1024*1024)
+#define CONFIG_FIP_SIZE			(2880*1024)
 #define CONFIG_ENV_IS_IN_MMC
 #define CONFIG_SYS_MMC_ENV_DEV		0
 #define	CONFIG_ENV_OFFSET		(CONFIG_FIP_OFFSET +\
 					 CONFIG_FIP_SIZE)
-#define CONFIG_ENV_SIZE			(4*1024)	/* env size */
+#define CONFIG_ENV_SIZE			(16*1024)	/* env size */
 #endif
 
 #if defined(CONFIG_MMC)
@@ -248,7 +250,7 @@
 	/* default: CONFIG_ENV_IS_NOWHERE */
 	#define CONFIG_ENV_IS_NOWHERE
 	#define	CONFIG_ENV_OFFSET		1024
-	#define CONFIG_ENV_SIZE			4*1024		/* env size */
+	#define CONFIG_ENV_SIZE			(4*1024)	/* env size */
 	/* imls - list all images found in flash, default enable so disable */
 	#undef	CONFIG_CMD_IMLS
 #endif
@@ -282,13 +284,101 @@
 /*-----------------------------------------------------------------------
  * ENV
  */
-#define CONFIG_EXTRA_ENV_SETTINGS	\
-			"fdt_high=0xffffffffffffffff"
-
-#define CONFIG_BOOTCOMMAND	\
-	"ext4load mmc 0:1 0x48000000 uImage; " \
-	"ext4load mmc 0:1 0x49000000 ramdisk.gz; " \
-	"ext4load mmc 0:1 0x4a000000 s5p6818-avn-ref.dtb; " \
-	"bootm 0x48000000 - 0x4a000000"
+
+#define CONFIG_DEFAULT_CONSOLE		"console=ttySAC3,115200n8\0"
+
+#define CONFIG_ROOT_DEV		0
+#define CONFIG_BOOT_PART	1
+#define CONFIG_MODULE_PART	2
+#define CONFIG_ROOT_PART	3
+
+#define CONFIG_DFU_ALT \
+	"bl1-emmcboot.img raw 0x1 0x80;" \
+	"fip-loader-emmc.img raw 0x81 0x280;" \
+	"fip-secure.img raw 0x301 0x600;" \
+	"fip-nonsecure.img raw 0xf01 0x800;" \
+	"/uImage ext4 0 1;" \
+	"/Image ext4 0 1;" \
+	"/uInitrd ext4 0 1;" \
+	"/ramdisk.gz ext4 0 1;" \
+	"/s5p6818-avn-ref-rev00.dtb ext4 0 1;" \
+	"/s5p6818-avn-ref-rev01.dtb ext4 0 1;" \
+	"boot part 0 1;" \
+	"modules part 0 2;" \
+	"rootfs part 0 3;" \
+	"params.bin raw 0x1701 0x20;" \
+	"/Image.itb ext4 0 2\0"
+
+#define CONFIG_EXTRA_ENV_SETTINGS					\
+	"fdt_high=0xffffffffffffffff\0"					\
+	"kerneladdr=0x40080000\0"					\
+	"kernel_file=Image\0"						\
+	"ramdiskaddr=0x49000000\0"					\
+	"ramdisk_file=uInitrd\0"					\
+	"fdtaddr=0x4a000000\0"						\
+	"fdtfile=\0"							\
+	"load_fdt="							\
+		"if test -z \"$fdtfile\"; then "			\
+		"success=0; "						\
+		"until test $loop -eq 0 || test $success -ne 0; do "	\
+			"if test $loop -lt 10; then "			\
+				"number=0$loop; "			\
+			"else number=$loop; "				\
+			"fi; "						\
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev01.dtb && setexpr success 1; " \
+			"setexpr loop $loop - 1; "			\
+			"done; "					\
+		"if test $success -eq 0; then "				\
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev00.dtb || "	\
+			"ext4load mmc $rootdev:$bootpart $fdtaddr s5p6818-avn-ref-rev01.dtb; "	\
+		"fi; "							\
+		"else ext4load mmc $rootdev:$bootpart $fdtaddr $fdtfile; "	\
+		"fi;\0"							\
+	"console=" CONFIG_DEFAULT_CONSOLE				\
+	"consoleon=setenv console=" CONFIG_DEFAULT_CONSOLE		\
+		"; saveenv; reset\0"					\
+	"consoleoff=setenv console=ram; saveenv; reset\0"		\
+	"rootdev=" __stringify(CONFIG_ROOT_DEV) "\0"			\
+	"rootpart=" __stringify(CONFIG_ROOT_PART) "\0"			\
+	"bootpart=" __stringify(CONFIG_BOOT_PART) "\0"			\
+	"root_rw=rw\0"							\
+	"opts=loglevel=4\0"						\
+	"rootfs_type=ext4\0"						\
+	"dfu_alt_info=" CONFIG_DFU_ALT					\
+	"lcd1_0=s6e8fa0\0"						\
+	"lcd2_0=gst7d0038\0"						\
+	"lcd_panel=s6e8fa0\0"						\
+	"sdrecovery=sd_recovery mmc 1:3 48000000 partmap_emmc.txt\0"	\
+	"factory_load=factory_info load mmc 0 "				\
+		__stringify(CONFIG_FACTORY_INFO_START) " "		\
+		__stringify(CONFIG_FACTORY_INFO_SIZE) "\0"		\
+	"factory_save=factory_info save mmc 0 "				\
+		__stringify(CONFIG_FACTORY_INFO_START) " "		\
+		__stringify(CONFIG_FACTORY_INFO_SIZE) "\0"		\
+	"factory_set_ethaddr=run factory_load; gen_eth_addr ;"		\
+		"factory_info write ethaddr $ethaddr;"			\
+		"run factory_save\0"					\
+	"load_args=run factory_load; setenv bootargs ${console} "	\
+		"root=/dev/mmcblk${rootdev}p${rootpart} ${root_rw} "	\
+		"rootfstype=${rootfs_type} ${opts} ${recoverymode} "	\
+		"drm_panel=$lcd_panel\0"				\
+	"load_kernel=ext4load mmc ${rootdev}:${bootpart} $kerneladdr $kernel_file\0" \
+	"load_initrd=ext4load mmc ${rootdev}:${bootpart} $ramdiskaddr $ramdisk_file\0" \
+	"boot_cmd_initrd="						\
+		"run load_fdt; run load_kernel; run load_initrd;"	\
+		"booti $kerneladdr $ramdiskaddr $fdtaddr\0"		\
+	"boot_cmd_mmcboot="						\
+		"run load_fdt; run load_kernel;"			\
+		"booti $kerneladdr - $fdtaddr\0"			\
+	"ramfsboot=run load_args; run boot_cmd_initrd\0"		\
+	"mmcboot=run load_args; run boot_cmd_mmcboot\0"			\
+	"recovery_cmd=run sdrecovery; setenv recoverymode recovery\0"	\
+	"recoveryboot=run recovery_cmd; run ramfsboot\0"		\
+	"hwtestboot=setenv rootdev 1;"					\
+		"setenv opts rootfstype=ext4 rootwait loglevel=7;"	\
+		"setenv fdtfile s5p6818-avn-explorer.dtb; "	\
+		"run mmcboot\0"						\
+	"hwtest_recoveryboot=run recovery_cmd; run hwtestboot\0"	\
+	"bootcmd=run ramfsboot\0"
 
 #endif /* __CONFIG_H__ */
-- 
2.7.4

